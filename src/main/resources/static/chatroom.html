<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whatever</title>

    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src = "/js/utils.js"></script>
    <script>
        let token = getToken();
        let roomId = getRequestParam("roomId");

        let send = function(message) {
            if(!window.WebSocket) {
                return ;
            }
            if(gamesocket.readyState == WebSocket.OPEN) {
                gamesocket.send(`{"remoteToken": "` + token + `", "type": "MESSAGE", "message": "` + message + `"}`);
            } else {
                alert("connection havent opened");
            }
        }

        let gamesocket, roomsocket;

        window.onload = () => {
            if(window.WebSocket) {
                let loginmessage = `{"remoteToken": "` + token + `", "type": "LOGIN", "message": ` + roomId + `}`;
                let logoutmessage = `{"remoteToken": "` + token + `", "type": "LOGOUT", "message": ` + roomId + `}`;

                let port = 8180 + parseInt(roomId) - 1;
                console.log(port);

                gamesocket = new WebSocket("ws://localhost:" + port + "/websocket");

                gamesocket.onmessage = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value += "\n" + ev.data;
                }
                gamesocket.onopen = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value = "connection started";
                    gamesocket.send(loginmessage);
                }
                gamesocket.onclose = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value += "\n" + "connection closed";
                }

                roomsocket = new WebSocket("ws://localhost:8190/websocket");
                roomsocket.onopen = (ev) => {
                    roomsocket.send(loginmessage);
                }

                // roomsocket.onclose = (ev) => {
                //     let logoutmessage = `{"remoteToken": "` + token + `", "type": "LOGOUT", "roomId": ` + roomId + `}`;
                //     roomsocket.send(logoutmessage);
                // }

                /*
                TODO
                在这里如果直接向前台发送消息,会无法接收,因为websocket尚且还没有建立起来.
                在之后应该完善成在这里阻塞,前台首先显示一个loading....
                直到建立完成之后发送一条确认信息到前台接受之后再回信 loginMessage.
                if(roomsocket.readyState == WebSocket.OPEN) {
                    roomsocket.send(loginMessage);
                }
                 */
            } else {
                alert("Explorer version is too low!");
            }
        }

        //TODO 我不知道为什么这里要写 ready 才会生效,而且似乎有时我注销掉 onclose 事件时这里并不会发送信息,无法复现
        $(document).ready(() => {
            window.onbeforeunload = function (e) {
                // e = e || window.event
                //
                // // 兼容IE8和Firefox 4之前的版本
                // if (e) {
                //     e.returnValue = `关闭提示`
                // }
                gamesocket.send(logoutmessage);
                roomsocket.send(logoutmessage);
                // Chrome, Safari, Firefox 4+, Opera 12+ , IE 9+
                // return `关闭提示`
            }
        });
    </script>
</head>
<body>

<form onsubmit="return false;">
    <h3> Chat Room </h3>
    <textarea id = "responseText" style = "width: 500px; height: 300px;"></textarea>
    <br>
    <input type = "text" name = "message" style = "width: 300px" value = "">
    <input type = "button" value = "send" onclick = "send(this.form.message.value)">
</form>
</body>
</html>