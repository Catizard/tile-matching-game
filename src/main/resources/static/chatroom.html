<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whatever</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src = "/js/utils.js"></script>
    <script>
        let token = getToken();
        let roomId = getRequestParam("roomId");

        let loginmessage = `{"remoteToken": "` + token + `", "type": "LOGIN", "message": ` + roomId + `}`;
        let logoutmessage = `{"remoteToken": "` + token + `", "type": "LOGOUT", "message": ` + roomId + `}`;

        let send = function(message) {
            if(!window.WebSocket) {
                return ;
            }
            if(gamesocket.readyState == WebSocket.OPEN) {
                gamesocket.send(`{"remoteToken": "` + token + `", "type": "MESSAGE", "message": "` + message + `"}`);
            } else {
                alert("connection havent opened");
            }
        }

        let sendmessage = () => {
            let textMessage = document.getElementById("textMessage");
            let message = textMessage.value;
            if(message === "") {
                return ;
            }
            console.log(message);
            send(message);
        }

        let gamesocket, roomsocket;

        window.onload = () => {
            if(window.WebSocket) {
                let port = 8180 + parseInt(roomId) - 1;
                console.log(port);

                gamesocket = new WebSocket("ws://localhost:" + port + "/websocket");

                gamesocket.onmessage = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value += "\n" + ev.data;
                }
                gamesocket.onopen = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value = "connection started";
                    gamesocket.send(loginmessage);
                }
                gamesocket.onclose = (ev) => {
                    let ta = document.getElementById("responseText");
                    ta.value += "\n" + "connection closed";
                }

                roomsocket = new WebSocket("ws://localhost:8190/websocket");
                roomsocket.onopen = (ev) => {
                    roomsocket.send(loginmessage);
                }

                /*
                TODO
                在这里如果直接向前台发送消息,会无法接收,因为websocket尚且还没有建立起来.
                在之后应该完善成在这里阻塞,前台首先显示一个loading....
                直到建立完成之后发送一条确认信息到前台接受之后再回信 loginMessage.
                if(roomsocket.readyState == WebSocket.OPEN) {
                    roomsocket.send(loginMessage);
                }
                 */
            } else {
                alert("Explorer version is too low!");
            }

            $.ajax({
                url: "/getMap",
                async: false,
                success: genMap
            });
        }

        /*
        TODO
         onbeforeunloadshi事件某些时候不会触发 原因未知
         根据 stackoverflow[https://stackoverflow.com/questions/27617019/onbeforeunload-not-working] 的说法
         首先这个函数需要一个返回值，其次要写成 addListener 的形式
         */
        window.addEventListener('beforeunload', () => {
            gamesocket.send(logoutmessage);
            roomsocket.send(logoutmessage);
        },false);

        // $(window).on('beforeunload',() => {
        //     gamesocket.send(logoutmessage);
        //     roomsocket.send(logoutmessage);
        // });

        let genMap = function (map) {
            // console.log(map);
            map = $.parseJSON(map);
            // console.log(map);
            //gen the basic map
            let divGround = document.getElementById("divGround");
            for(let i = 0;i < 10;++i) {
                divGround.innerHTML += "<div id = divInner" + (i + 1) + "></div>";
            }
            for(let i = 0;i < 10;++i) {
                let divInner = document.getElementById("divInner" + (i + 1));
                for(let j = 0;j < 10;++j) {
                    let num = i * 10 + j;
                    let imgUrl = "img/sprBlock" + map[num] + ".png";
                    divInner.innerHTML += "<button id = \"buttonBlock" + num + "\" style=\"background: url(" + imgUrl + "); width: 64px; height: 64px;\"></button>"
                }
            }
            //bind the click event
            for(let i = 0;i < 10;++i) {
                for(let j = 0;j < 10;++j) {
                    let num = i * 10 + j;
                    let buttonBlock = document.getElementById("buttonBlock" + num);
                    buttonBlock.onclick = () => {
                        console.log(buttonBlock.style.background);
                        if(buttonBlock.style.background === "url(\"img/sprBlock0.png\")") {
                            return ;
                        }
                        $.ajax({
                            url: "/addBlock",
                            type: "GET",
                            data: {
                                blockId: num
                            },
                            success: (result) => {
                                result = $.parseJSON(result);
                                if(result.length === 2) {
                                    console.log(result);
                                    (document.getElementById("buttonBlock" + result[0])).style.background = "url(\"img/sprBlock0.png\")";
                                    (document.getElementById("buttonBlock" + result[1])).style.background = "url(\"img/sprBlock0.png\")";
                                }
                            }
                        });
                    }
                }
            }
        }

        // let testQuery = function () {
        //     console.log("testQuery" + token);
        //     $.ajax({
        //         url: "/testQuery",
        //         data: {
        //             remoteToken: token
        //         },
        //         type: "GET",
        //         success: () => {
        //             console.log("query ok");
        //         }
        //     })
        // }

        // window.onload = () => {
        //     $.ajax({
        //         url: "/getMap",
        //         async: false,
        //         success: genMap
        //     });
        //
        //     // let testButton = document.getElementById("testButton");
        //     // testButton.onclick = testQuery;
        // }
    </script>
</head>
<body>

<!--<form onsubmit="return false;">-->
<!--    <h3> Chat Room </h3>-->
<!--    <textarea id = "responseText" style = "width: 500px; height: 300px;"></textarea>-->
<!--    <br>-->
<!--    <input type = "text" name = "message" style = "width: 300px" value = "">-->
<!--    <input type = "button" value = "send" onclick = "send(this.form.message.value)">-->
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10">
                <!-- left panel -->
                <div class="container-fluid">
                    <div class="row" id="divGround">
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <!-- left panel -->
                <div style="display: inline-flex; flex-direction: column; height: 100vh;">
                    <textarea id="responseText" style="flex: 1"></textarea>
                    <input type = "text" name = "message" id="textMessage" value = "">
                    <input type = "button" value = "send" onclick = "sendmessage()">
                </div>
            </div>
        </div>
    </div>
<!--</form>-->
</body>
</html>